<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ú–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç–µ</title>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; }

    #controls {
      position: absolute;
      top: 100px;
      left: 10px;
      background: rgb(75, 75, 75);
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      z-index: 1000;
      width: 250px;
      font-family: sans-serif;
      color: rgb(255, 255, 255);
    }

    #controls h4 {
      width: 200px;
      height: 30px;
      margin-top: 0;
      display: flex;
      align-items: center;  /* –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
      justify-content: center; /* –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
      box-shadow: 0 0 10px rgb(0, 0, 0);
      border-radius: 8px;
      background: rgba(65, 65, 65, 0.95);
    }

    .coord-block {
      margin-bottom: 10px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }

    label {
      display: inline-block;
      width: 70px;
      font-size: 14px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.47);
      border-radius: 8px;
    }

    input {
      width: 90px;
      margin-bottom: 4px;
    }

    button {
      width: 100%;
      margin-top: 5px;
      padding: 5px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: #0078ff;
      color: white;
    }

    button:hover {
      background: #005fcc;
    }

    .small-btn {
      width: auto;
      font-size: 12px;
      background: #888;
      margin-left: 5px;
    }

    .small-btn.active {
      background: #ff8800;
    }
  </style>
</head>
<body>
  <div id="controls">
    <h4>–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</h4>

    <!-- –ë–ª–æ–∫ –Ω–∞—á–∞–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∞ -->
    <div class="coord-block">
      <b>–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞</b><br>
      <label>–®–∏—Ä–æ—Ç–∞:</label>
      <input id="start_lat" placeholder="55.7" value="55.704250"><br>
      <label>–î–æ–ª–≥–æ—Ç–∞:</label>
      <input id="start_lon" placeholder="37.6" value="37.646103">
      <button id="pickStartBtn" class="small-btn">üìç –í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
    </div>

    <!-- –ë–ª–æ–∫ –∫–æ–Ω—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–∞ -->
    <div class="coord-block">
      <b>–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞</b><br>
      <label>–®–∏—Ä–æ—Ç–∞:</label>
      <input id="end_lat" placeholder="55.6" value="55.636524"><br>
      <label>–î–æ–ª–≥–æ—Ç–∞:</label>
      <input id="end_lon" placeholder="37.6" value="37.654592">
      <button id="pickEndBtn" class="small-btn">üìç –í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <button id="buildBtn">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
    <button id="clearBtn" style="background:#aaa;">–û—á–∏—Å—Ç–∏—Ç—å</button>
  </div>

  <div id="map"></div>

  <script>
    // === 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã ===
    const CENTER = [parseFloat("{{ center_lat }}"), parseFloat("{{ center_lon }}")];

    const map = L.map("map").setView(CENTER, 12);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a>'
    }).addTo(map);

    let startMarker = null;
    let endMarker = null;
    let routeLine = null;

    // –†–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏
    let pickMode = null; // "start" –∏–ª–∏ "end"

    // === 2. –í—ã–±–æ—Ä —Ç–æ—á–∫–∏ –∫–ª–∏–∫–æ–º ===
    map.on("click", e => {
      if (!pickMode) return;

      const { lat, lng } = e.latlng;
      if (pickMode === "start") {
        document.getElementById("start_lat").value = lat.toFixed(6);
        document.getElementById("start_lon").value = lng.toFixed(6);

        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker([lat, lng], { draggable: true })
          .addTo(map)
          .bindPopup("–ù–∞—á–∞–ª–æ").openPopup();

      } else if (pickMode === "end") {
        document.getElementById("end_lat").value = lat.toFixed(6);
        document.getElementById("end_lon").value = lng.toFixed(6);

        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker([lat, lng], { draggable: true })
          .addTo(map)
          .bindPopup("–ö–æ–Ω–µ—Ü").openPopup();
      }

      deactivatePickMode();
    });

    // === 3. –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏ ===
    const pickStartBtn = document.getElementById("pickStartBtn");
    const pickEndBtn = document.getElementById("pickEndBtn");

    function deactivatePickMode() {
      pickMode = null;
      pickStartBtn.classList.remove("active");
      pickEndBtn.classList.remove("active");
    }

    pickStartBtn.addEventListener("click", () => {
      if (pickMode === "start") {
        deactivatePickMode();
      } else {
        pickMode = "start";
        pickStartBtn.classList.add("active");
        pickEndBtn.classList.remove("active");
      }
    });

    pickEndBtn.addEventListener("click", () => {
      if (pickMode === "end") {
        deactivatePickMode();
      } else {
        pickMode = "end";
        pickEndBtn.classList.add("active");
        pickStartBtn.classList.remove("active");
      }
    });

    // === 4. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë ===
    document.getElementById("clearBtn").addEventListener("click", () => {
      if (startMarker) map.removeLayer(startMarker);
      if (endMarker) map.removeLayer(endMarker);
      if (routeLine) map.removeLayer(routeLine);
      document.getElementById("start_lat").value = "";
      document.getElementById("start_lon").value = "";
      document.getElementById("end_lat").value = "";
      document.getElementById("end_lon").value = "";
      deactivatePickMode();
    });

    // === 5. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ ===
    document.getElementById("buildBtn").addEventListener("click", async () => {
      const startLat = parseFloat(document.getElementById("start_lat").value);
      const startLon = parseFloat(document.getElementById("start_lon").value);
      const endLat = parseFloat(document.getElementById("end_lat").value);
      const endLon = parseFloat(document.getElementById("end_lon").value);

      if (isNaN(startLat) || isNaN(startLon) || isNaN(endLat) || isNaN(endLon)) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–∞.");
        return;
      }

      const resp = await fetch("/build_route", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          start: [startLat, startLon],
          end: [endLat, endLon]
        })
      });

      const data = await resp.json();
      if (routeLine) map.removeLayer(routeLine);

      const coords = data.route.map(pt => [pt[0], pt[1]]);
      routeLine = L.polyline(coords, { color: "blue", weight: 5 }).addTo(map);
      map.fitBounds(routeLine.getBounds());

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏–º –º–∞—Ä–∫–µ—Ä—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
      if (!startMarker) {
        startMarker = L.marker(coords[0], { draggable: false })
          .addTo(map).bindPopup("–ù–∞—á–∞–ª–æ");
      }
      if (!endMarker) {
        endMarker = L.marker(coords[coords.length - 1], { draggable: false })
          .addTo(map).bindPopup("–ö–æ–Ω–µ—Ü");
      }
    });
  </script>
</body>
</html>
